services:
  # Mail Archive — main application (Go)
  mails:
    build: .
    container_name: mails
    user: "${DOCKER_UID:-1000}:${DOCKER_GID:-1000}"
    restart: unless-stopped
    ports:
      - "8090:8090"
    volumes:
      - ./users:/app/users
    environment:
      TZ: Europe/Berlin
      LISTEN_ADDR: ":8090"
      DATA_DIR: /app/users
      BASE_URL: "${BASE_URL:-http://localhost:8090}"
      # OAuth providers (set in .env or shell)
      GITHUB_CLIENT_ID: "${GITHUB_CLIENT_ID:-}"
      GITHUB_CLIENT_SECRET: "${GITHUB_CLIENT_SECRET:-}"
      GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID:-}"
      GOOGLE_CLIENT_SECRET: "${GOOGLE_CLIENT_SECRET:-}"
      FACEBOOK_CLIENT_ID: "${FACEBOOK_CLIENT_ID:-}"
      FACEBOOK_CLIENT_SECRET: "${FACEBOOK_CLIENT_SECRET:-}"
      # Similarity search (optional)
      QDRANT_URL: "http://127.0.0.1:6334"
      OLLAMA_URL: "http://172.17.0.1:11434"
      EMBED_MODEL: "all-minilm"
    network_mode: host
    develop:
      watch:
        - action: rebuild
          path: .
          ignore:
            - users/
            - scripts/
            - emails/
            - data/
            - "*.md"

  # Vector DB for similarity search (optional)
  qdrant:
    image: qdrant/qdrant:latest
    container_name: qdrant
    restart: unless-stopped
    volumes:
      - qdrant_storage:/qdrant/storage
    ports:
      - "6333:6333"
      - "6334:6334"

  # Test IMAP/POP3/SMTP server — use with: docker compose --profile test up
  greenmail:
    image: greenmail/standalone:2.1.2
    container_name: greenmail
    environment:
      GREENMAIL_OPTS: "-Dgreenmail.setup.test.all -Dgreenmail.hostname=0.0.0.0 -Dgreenmail.auth.disabled"
    ports:
      - "3025:3025"   # SMTP
      - "3110:3110"   # POP3
      - "3143:3143"   # IMAP
    profiles:
      - test

volumes:
  qdrant_storage:
